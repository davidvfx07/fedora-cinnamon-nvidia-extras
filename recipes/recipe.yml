# yaml-language-server: $schema=https://schema.blue-build.org/recipe-v1.json

name: fedora-cinnamon-nvidia-extras

description: Custom immutable Fedora Cinnamon image with NVIDIA/CUDA, development tools, VMs, and more.

base-image: ghcr.io/ublue-os/base-nvidia
image-version: 42

modules:
  - type: dnf
    repos:
      files:
        #- https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-42.noarch.rpm
        #- https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-42.noarch.rpm
        - https://src.fedoraproject.org/rpms/fedora-repos/raw/f42/f/fedora-cisco-openh264.repo
        #- https://copr.fedorainfracloud.org/coprs/atim/starship/repo/fedora-42/atim-starship-fedora-42.repo
      copr:
        - atim/starship
      nonfree: rpmfusion
    install:
      allow-erasing: true
      packages:
        - gdm
        - xorg-x11-server-Xorg

        - gnome-shell-extension-gsconnect

        # Virtualization Tools
        - virt-manager # Virtual Machine Manager GUI
        - libvirt # Virtualization library and daemon
        - virt-install # Command line tool for installing VMs

        # Alternative Terminal and Text Editor
        - ptyxis # Second terminal emulator
        - geany # Second lightweight text editor
        - starship
        - conda

        # Multimedia Codecs and Thumbnail Generators
        - ffmpeg
        - gstreamer1
        - gstreamer1-plugin-libav # FFmpeg plugin for GStreamer
        - libvkd3d
        # - intel-media-driver # Intel Media Driver for VAAPI (if you have Intel iGPU)

        - openh264 # Cisco OpenH264 codec

        # Thumbnailers
        - ffmpegthumbnailer
        - gnome-directory-thumbnailer
        - gnome-kra-ora-thumbnailer
        - tumbler

        # Packages for working with Apple Devices
        - usbmuxd
        - libimobiledevice-utils
        - ifuse 

        - android-tools

        # Extensive Development Extras
        - make
        - gcc
        - git
        - cmake
        - htop
        - nano
        - gdb
        - valgrind
        - strace
        - ltrace
        - pkgconf-pkg-config
        - zlib-devel
        - bzip2-devel
        - xz-devel
        - openssl-devel
        - elfutils-libelf-devel
        - libffi-devel
        - readline-devel
        - ncurses-devel
        - usbutils
        - lshw
        - pciutils
        - ddrescue

    remove:
      packages:
        - noopenh264
        - thunderbird
        - hexchat
        - mpv
        - slick-greeter
        - slick-greeter-cinnamon

    group-install:
      with-optional: false # install optional packages from group
      packages:
        - cinnamon-desktop

  - type: systemd
    system:
      enabled:
        - gdm.service
        - libvirtd.service

  - type: script
    snippets:
      # Create the gdm user and group, which dnf install won't do
      - 'set -euxo pipefail; if ! getent group gdm > /dev/null; then; groupadd -r gdm; fi; if ! getent passwd gdm > /dev/null; then; useradd -r -g gdm -d /var/lib/gdm -s /usr/sbin/nologin -c "GNOME Display Manager daemon user" gdm'

  - type: files
    files:
      - source: system
        destination: /

  - type: kargs
    kargs:
      - nvidia-drm.modeset=1 # Enables NVIDIA DRM modesetting (often needed for Wayland)
      - rd.driver.blacklist=nouveau # Blacklists the open-source Nouveau driver to prevent conflicts

  - type: default-flatpaks
    system:
      install:
        - org.videolan.VLC
        - org.mozilla.firefox
        - org.chromium.Chromium
        - com.github.tchx84.Flatseal
        - org.fedoraproject.MediaWriter
    user:
      install:
        - com.usebottles.bottles

  - type: fonts
    fonts:
      nerd-fonts:
        - FiraCode
        - Hack
        - SourceCodePro
        - Terminus
        - JetBrainsMono
        - NerdFontsSymbolsOnly